---
# CI/CD Pipeline for NextDNS Operator
# Runs linting, testing, container builds, and Helm chart publishing
name: CI/CD

"on":
  push:
    branches: [main]
  workflow_dispatch:

# Only allow one release at a time - queue subsequent runs
concurrency:
  group: release
  cancel-in-progress: false

permissions:
  contents: write
  packages: write
  issues: write
  pull-requests: write

jobs:
  # Lint YAML, Helm charts, and Go code
  lint:
    uses: jacaudi/github-actions/.github/workflows/lint.yml@v0.6.0
    permissions:
      contents: read
    with:
      yaml: true
      helm: true
      go: true
      go-version: '1.25'
      helm-chart-path: 'chart'

  # Run Go tests with coverage
  test:
    uses: jacaudi/github-actions/.github/workflows/test.yml@v0.6.0
    permissions:
      contents: read
    with:
      test-framework: 'go'
      go-version: '1.25'
      coverage: true
      coverage-threshold: 70
      test-packages: './internal/controller/... ./internal/nextdns/...'

  # Create semantic version and GitHub release (main branch only)
  release:
    needs: [lint, test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    uses: jacaudi/github-actions/.github/workflows/semantic-release.yml@v0.6.0
    permissions:
      contents: write
      issues: write
      pull-requests: write
    with:
      use-github-app: true
      allow-initial-development-versions: true
    secrets:
      app-id: ${{ secrets.APP_ID }}
      app-private-key: ${{ secrets.APP_PRIVATE_KEY }}

  # Build multi-arch container images
  docker:
    needs: [release]
    if: needs.release.outputs.new-release-published == 'true'
    uses: jacaudi/github-actions/.github/workflows/docker-build.yml@v0.6.0
    permissions:
      contents: read
      packages: write
    with:
      image-name: ${{ github.repository }}
      platforms: 'linux/amd64,linux/arm64'
      tags: |
        ghcr.io/${{ github.repository }}:${{ needs.release.outputs.new-release-version }}
        ghcr.io/${{ github.repository }}:latest

  # Scan container image for vulnerabilities
  scan:
    needs: [release, docker]
    if: needs.release.outputs.new-release-published == 'true'
    uses: jacaudi/github-actions/.github/workflows/image-scan.yml@v0.6.0
    permissions:
      contents: read
      packages: read
      security-events: write
    with:
      image-ref: ghcr.io/${{ github.repository }}:${{ needs.release.outputs.new-release-version }}
      severity: 'CRITICAL,HIGH'
      exit-code: 0

  # Validate chart and container version alignment before publishing
  validate-versions:
    name: Validate Version Alignment
    needs: [release, docker]
    if: needs.release.outputs.new-release-published == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Validate version formats
        env:
          RELEASE_VERSION: ${{ needs.release.outputs.new-release-version }}
        run: |
          set -euo pipefail

          echo "Release version: ${RELEASE_VERSION}"

          # Verify no double v prefix
          if [[ "${RELEASE_VERSION}" == vv* ]]; then
            echo "::error::Double 'v' prefix detected: ${RELEASE_VERSION}"
            exit 1
          fi

          # Container and chart should use the same version tag
          echo "Container tag: ${RELEASE_VERSION}"
          echo "Chart appVersion: ${RELEASE_VERSION}"

          echo "Version validation passed"

      - name: Verify container image exists
        env:
          RELEASE_VERSION: ${{ needs.release.outputs.new-release-version }}
        run: |
          set -euo pipefail

          IMAGE="ghcr.io/${{ github.repository }}:${RELEASE_VERSION}"
          echo "Checking for container image: ${IMAGE}"

          if ! docker manifest inspect "${IMAGE}" > /dev/null 2>&1; then
            echo "::error::Container image not found: ${IMAGE}"
            exit 1
          fi

          echo "Container image verified: ${IMAGE}"

  # Publish Helm chart to OCI registry
  helm:
    needs: [release, scan, validate-versions]
    if: needs.release.outputs.new-release-published == 'true'
    uses: jacaudi/github-actions/.github/workflows/helm-publish.yml@v0.6.0
    permissions:
      contents: read
      packages: write
    with:
      chart-name: nextdns-operator
      chart-path: chart
      repository: ${{ github.repository_owner }}/charts
      version: ${{ needs.release.outputs.new-release-version }}
      app-version: ${{ needs.release.outputs.new-release-version }}
      registry: ghcr.io
      registry-username: ${{ github.repository_owner }}
